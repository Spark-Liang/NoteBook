### TCP简介和报文结构

- 简介

- 报文结构
  
  - 头部结构
  - tcpdump对应头部结构
  - 

#### 简介

TCP特点：面向连接、字节流和可靠传输。

- 面向连接：存在打开和关闭连接的操作

- 字节流：通过TCP协议的处理，上层应用接收到的是有序的字节流。

- 可靠传输：保证传输的数据是完整的

- 全双工：连接两端都支持同时发送和接收。

标识一个TCP连接需要通过源IP，源端口号，目标IP和目标端口号四元祖，其中源和目标IP信息在IP报文中。

#### 报文结构

##### 头部结构

![](E:\Notebook\Personal\NoteBook\img\3a99875b374730129b98f91e4d18412ad4620355.jpg)

结构内容：

- 源和目标端口号

- 序号seq：代表当前数据包的其实字节在发送端的序号。

- 确认号ACK：代表接收端当前已接收到的字节序号，发送端根据收到的确认号决定发送那个范围的字节序列。

- 头部长度：TCP的头部结构没有包含数据长度，具体的数据长度是IP报文记录的长度减去TCP头部长度。

- 窗口大小：表示发送端作为接收端时的滑动窗口大小。

##### 头部标志位

目前包含6个标志位

- URG：包是否紧急处理，紧急指针对应的数据包需要紧急处理

- ACK：表示确认收到消息

- PSH：表示收到该报文后，立刻将缓冲区的数据传递到应用层。**通常用在应用层请求的最后一个数据包**

- RST：关闭当前连接，当接收端收到该标志位的数据包，立刻关闭连接，丢弃缓冲区数据。

- SYN：请求打开连接。

- FIN：请求关闭连接。

##### 头部选项

结构如下：

![](E:\Notebook\Personal\NoteBook\img\114a40e92c5b093982e45a22ef03fba1e7112114.jpg)

- 类型：表示选项的类型

- length：整个选项的长度

- 选项的信息

当前tcp支持的选项类型和作用有：

![](E:\Notebook\Personal\NoteBook\img\022bad6a68b459d83872dbd680e316e74c44bc15.png)

常见options作用：

- NOP：常用于对齐字节

- MSS：发送端接收消息的最大消息长度，通常是MTU - IP报头部长度 - TCP报长度。

- SACK-Permitted：又叫`scakOK`代表接收端是否支持scak

- sack：用于告诉发送端，接收端已接收到的报文片段的范围列表，避免发送端重复重传

- TSopt：存放发送端当前和对应响应的数据包的时间戳
  
  - TS val：存放发送端的时间戳

[TCP系列08—连接管理—7、TCP 常见选项(option) - lshs - 博客园](https://www.cnblogs.com/lshs/p/6038494.html)

##### tcpdump对应头部结构

![](E:\Notebook\Personal\NoteBook\img\d6ed64ee460ed46255afb763ec948e7ef1c0ba79.png)


