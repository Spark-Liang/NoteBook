### tcpdump与tcp协议

- tcpdump
  
  - 安装
  
  - 使用选项
  
  - 报文内容

- tcp协议

#### tcpdump

##### 安装

```bash
yum install -y tcpdump
```

##### 使用选项

###### 控制显示内容选项：

- `-n`：主机使用ip而不是FQDN显示

- `-nn`：主机使用ip显示，端口使用数字显示

- `-e`：输出包的链路层头部信息

- `-S`: 使用绝对值但不是相对值显示tcp的 seq 和 ack 值。

- 打印时间相关选项：（默认打印当前时间）
  
  - `-t`: **不打印**时间戳
  
  - `-tt`：每一行打印时间戳
  
  - `-ttt`：每一行相对上一行日志的时间，相当于包与包之间的时间差。单位是毫秒
  
  - `-tttt`：相对当前开始的时间差。
  
  - `-tttt`：相对开始超级的时间差，单位是毫秒。

- 打印信息的详细程度：
  
  - `-v`：

- 是否打印数据内容选项：

- 

###### 控制输出位置选项：

- 

###### 过滤内容相关选项

- `-i`：监听某个网卡设备的数据包，**不指定则使用第一个网卡**。

###### 过滤表达式

一个命令中只能有一个过滤表达式，由于tcpdump会把所有不带`-`前缀的选项当作表达式的内容，所以推荐将过滤相关内容放在命令的最后。<br>

主机端口条件：

```
[方向修饰符] [类型修饰符] 标识符
```

- `方向修饰符`：`src`，`dst`，`src or dst` （默认），`src and dst`

- `类型修饰符`：`host`（默认），`net`网段 和 `port` 端口

- `标识符`：ip 或者 网段前缀，端口号

协议类型条件：<br>

支持过滤的协议类型：**ether，ip，ip6，arp，rarp，tcp，udp**

逻辑运算符：<br>

- 与：`and` 或者`&&`

- 或：`or`或者`||`

- 非：`not`或者`!`



###### 报文内容

tcp：<br>

tcp报文有两种显示模式分别是默认和`-v`两种模式。`-v`模式会增加显示IP报头的信息。

<img src="file:///E:/Notebook/Personal/NoteBook/img/12d158045c7f54a9904b62ea28653ea96cbb2e7f.png" title="" alt="" data-align="center">

通常tcpdump对tcp数据包的显示格式如下:  <br>src > dst: flags seq ack win options length

- src： 源端口地址

- dst：目标端口地址

- flags：tcp的标志位
  
  - [S] 表示这是一个SYN请求
  
  - [.] 表示这是一个ACK确认包，(client)SYN->(server)SYN->(client)ACK 就是3次握手过程
  
  - [P] 表示这个是一个数据推送，可以是从服务器端向客户端推送，也可以从客户端向服务器端推
  
  - [F] 表示这是一个FIN包，是关闭连接操作，client/server都有可能发起
  
  - [R] 表示这是一个RST包，与F包作用相同，但RST表示连接关闭时，仍然有数据未被处理。可以理解为是强制切断连接

- seq：即tcp的seq序列号。当没有`-S`选项为相对序列

- ack：即tcp的ack序列号。当没有`-S`选项为相对序列

- win：代表tcp的滑动窗口大小

#### tcp协议


