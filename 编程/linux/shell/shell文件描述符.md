#### shell文件描述符

- shell脚本中文件描述符相关操作
  
  - 文件描述符简介
  
  - 打开、关闭和使用文件描述符
  
  - 文件描述符的使用范围
  
  - 特殊的文件描述符

- 与文件描述符相关的命令工具
  
  - lsof

##### shell脚本中文件描述符相关操作

###### 文件描述符简介

- shell 的文件描述符相当于打开了一个文件句柄，用于做输入输出的重定向。

- 在shell中使用 exec 命令打开文件描述符时，是不会对文件进行锁定。即另一个进程可以对打开了文件描述符的文件进行删除。

- 对于文件描述符，其作用更像一个读写文件的游标或指针。

- 在shell中有三个标准的文件描述符，0,1,2 。分别代表 stdin，stdout，stderr。这三个的描述符都是可读写的，并且都指向当前shell所使用的终端

##### 打开、关闭和使用文件描述符

在shell中使用 exec 命令打开和关闭文件描述符。以打开文件 test.txt 作为描述符 3 为例。**其中左侧的文件描述符数字要紧贴 < 或 >。**

- 打开只读描述符：exec  3< test.txt

- 打开只写描述符：exec 3> test.txt

- 打开读写描述符：exec 3<> test.txt

- 关闭描述符： exec 3>&-

文件描述符的读写，以描述符 3 为例

- 直接写入某些内容： echo abc 1>&3

- 从文件描述符中读入： cat <&3

- 当存在多个文件描述符的操作时, 会按照从左往右的顺序依次执行. 例如通过命令 `cmd 3>&1 1>&2 2>&3 3>&-` 就可以交换 stdin 和 stdout.

###### 文件描述符的使用范围

###### 特殊的文件描述符

- <(cmd) : 可以看作时一个可读文件, cmd 命令的输出是这个文件的内容;
- \> (cmd) : 可以看作时一个可写文件, cmd 会接受输入并进行处理;

##### 与文件描述符相关的命令工具

###### lsof

这个工具用于查看所有打开的文件，意为"list open file".

输出的每一列对应的内容是：

- COMMAND：进程的名称 PID：进程标识符

- USER：进程所有者  

- FD：文件描述符，应用程序通过文件描述符识别该文件。如cwd、txt等 TYPE：文件类型，如DIR、REG等

- DEVICE：指定磁盘的名称

- SIZE：文件的大小

- NODE：索引节点（文件在磁盘上的标识）

- NAME：打开文件的确切名称

**常用选项（其中筛选相关的选项只能同时使用一个）：**

- -p：筛选指定进程打开的文件。例子：lsof -p \$\$
- -u：筛选指定用户打开的文件
- -c：查看指定程序打开的文件
- 文件相关
  - -d：使用文件描述符进行筛选，
  - +d：递归筛选文件目录。如 -d /home 则筛选的是在home 目录下，所有被打开的目录
  - +D：递归筛选文件。筛选某个目录下被打开的文件
- 网络相关
  - -i：查看任何程序打开的网络连接
    
    用法： lsof -i [46][protocol][@hostname|hostaddr][:serivce|port]     
    
    说明：　4 6　　IPv4 或 IPv6
    
    注意点：每个选项之间没有空格。比如需要TCP 4 的80端口，-i 4:80
    
    protocol TCP or UDP     
    
    hostname internet host name     
    
    hostaddr IPv4地址     
    
    service /etc/service中的service name     
    
    port 端口
- 显示相关：
  - -R：增加PPID 列，显示父进程。
  - -r：按照指定时间间隔刷新页面。
