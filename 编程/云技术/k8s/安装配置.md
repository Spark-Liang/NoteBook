### 安装配置

- 安装

- 其他辅助工具安装

#### 安装

##### 安装配置依赖环境

1. 配置网卡设置为固定ip，配置文件为`/etc/sysconfig/network-scripts/ifcfg-<网卡名>`
   
   1. 修改配置项`BOOTPROTO`为`static`，表示使用静态ip
   
   2. IPADDR，配置为本机的固定ip
   
   3. NETMASK，网段的网络掩码一般是`255.255.255.0`
   
   4. GATEWAY，网关地址
   
   5. DNS1，dns服务器地址，常用是`223.5.5.5`

2. 配置yum为阿里源

3. 关闭swap空间
   
   ```bash
   swapoff -a 
   ```
   
   编辑`/etc/fstab` 注释掉类型为swap的分区

4. 关闭selinux和防火墙
   
   - 修改`/etc/selinux/config`中的`SELINUX`为`disable`
   
   - 停止防火墙
     
     ```bash
     systemctl disable firewalld
     systemctl stop firewalld
     ```
   
   - 

5. 配置启动网桥和ip转发，在配置文件`/etc/sysctl.conf`添加以下内容，然后使用`sysctl -p`生效配置
   
   ```bash
   net.bridge.bridge-nf-call-ip6tables = 1
   net.bridge.bridge-nf-call-iptables = 1
   net.ipv4.ip_forward = 1
   ```
   
   使用命令`modprobe br_netfilter`先加载依赖的内核模块，然后使用`sysctl -p`加载内核配置。

6. 安装常用包
   
   ```bash
   yum install vim bash-completion net-tools gcc -y
   ```

7. 安装docker，并配置镜像加速
   
   k8s版本与docker版本对应关系，参考k8s的change log。[kubernetes/CHANGELOG at master · kubernetes/kubernetes · GitHub](https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG)
   
   使用阿里云源安装docker-ce
   
   ```bash
   yum install -y yum-utils device-mapper-persistent-data lvm2
   yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
   yum -y install docker-ce
   ```

##### 安装配置k8s环境

1. 添加k8s阿里云源

```bash
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
```

2. 安装k8s相关工具`kubectl kubelet kubeadm`，需要注意三个工具的版本必须相同
   
   ```bash
   K8S_VERSION=1.18.20
   yum install kubectl-${K8S_VERSION} kubelet-${K8S_VERSION} kubeadm-${K8S_VERSION} -y
   ```

3. 检查k8s依赖的docker镜像，并拉取缺少的镜像
   
   通过命令`kubeadm config images list`获取镜像列表，并将列表中的`k8s.gcr.io`替换为`registry.cn-hangzhou.aliyuncs.com/google_containers`，从而使用阿里云的仓库拉取

4. 使用`kubeadm init`初始化k8s集群

```bash
kubeadm init --kubernetes-version=1.18.0  \
--apiserver-advertise-address=192.168.122.21   \
--image-repository registry.aliyuncs.com/google_containers  \
--service-cidr=10.10.0.0/16 --pod-network-cidr=10.122.0.0/16
```

常用选项：

- `--kubernetes-version`: 对应安装时的`K8S_VERSION`
- `--apiserver-advertise-address`: 对应当前master主机的ip
- `--image-repository`:初始化时使用的镜像仓库
- `--ignore-preflight-errors`:忽略初始化时的某些报错，常见忽略Swap报错
  - `--ignore-preflight-errors=Swap`

常见错误：

- kubelet isn't running or healty
  原因是kubelet没有启动正常，需要检查 `/var/log/messages` 查看原因
- 

常见配置：

- 启动swap运行k8s
  需要配置文件`/etc/sysconfg/kubelet`中的`KUBELET_EXTRA_ARGS=` 后面添加`--fail-swap-on=false`避免启动kubelet报错

- 配置docker的`cgroupdriver`为`systemd`
  
  在`/etc/docker/daemon.json`中添加配置项
  
  ```json
  { "exec-opts": ["native.cgroupdriver=systemd"]
  }
  ```
  
  并使用`systemctl daemon-reload`和`systemctl restart docker`是配置生效

- 配置kubelet使用`cgroupfc`，需要在`/etc/sysconfig/kubelet`添加选项`--cgroup-driver=cgroupfs`
5. 当初始化完成后，使用`kubectl get pods`会发现`coredns`的pod处于pending状态。是因为缺少网络引擎，安装`calico`网络。
   
   - 安装 `calico` 网络
     
     ```bash
     wget  https://docs.projectcalico.org/manifests/calico.yaml -O /etc/kubernetes/manifests/calico.yaml --no-check-certificate
     kubectl apply -f /etc/kubernetes/manifests/calico.yaml
     ```
- 安装 `flannel` 网络
  从[kube-flannel](https://github.com/flannel-io/flannel/blob/master/Documentation/kube-flannel.yml)下载k8s配置文件，然后安装到集群中
  
  ```bash
  kubectl apply -f kube-flannel.yml
  ```
6. ###### 其他节点加入

使用`kubeadm join`可以使其他节点加入初始化好的主节点，在集群初始化完成后，会给出其他节点加入的命令如：

```bash
kubeadm join 192.168.188.129:6443 --token 57816t.o0gzqldg8jyt4wqc \
    --discovery-token-ca-cert-hash sha256:e312deae635734e69e9f49b59f13f56429e52ee030ccbf8515c52fc79ec62a38
```

运行完后，需要拷贝主节点的`$HOME/.kube/config`文件到新节点上。

**同时还能通过命令`kubeadm token create --print-join-command`查看加入命令**

4. ###### 参考文档
- [使用kubeadm在Centos8上部署kubernetes1.18_Kubernetes中文社区](https://www.kubernetes.org.cn/7189.html)

#### 其他辅助工具安装

##### kubens

kubens可用于切换当前用户的默认namespace。

安装命令

```bash
git clone https://github.com/ahmetb/kubectx
cp kubectx/kube* /usr/local/bin/
```
