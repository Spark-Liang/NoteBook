### 认证体系

- 体系简介

- 密钥对身份认证方式
  
  - 用户创建
  
  - 多用户上下文切换

- 服务账户

#### 体系简介

k8s的身份认证体系是apiserver进行权限控制的第一步，用于确认当前发起请求的客户端的身份。k8s的apiServer本身是没有提供管理用户身份信息的功能，由身份认证模块提供认证功能，目前支持的模块类型有：

- x509密钥对方式

- Service Account Token

- OpenID Connect（第三方提供的OAuth服务接口）

- Authentication Proxy

- 静态token 文件

k8s的认证模块和授权模块之间是通过主体标识进行关联，授权模块把角色授予某个主体标识，认证模块确定当前请求具有什么主体标识。

主体标识结构是：

`< 主体组 >:< 主体id >`

目标k8s包含以下特殊目的的组：

- `system:unauthenticated` ：未能通过任何一个授权插件检验的账号，即未通过认证测 试的用户所属的组 。

- `system:authenticated` ：认证成功后的用户自动加入的一个组，用于快捷引用所有正常通过认证的用户账号。

- `system:serviceaccounts` ：当前系统上的所有 Service Account 对象。服务对象的主体id结构是`< namespace >:< name >`

- `system:masters`：由kubeadm创建的系统管理员

![](E:\Notebook\Personal\NoteBook\img\52425d5b92e26a3069639880e65005cb3c56721a.png)

#### 密钥对身份认证方式

密钥对的原理是利用数字证书体系确认当前请求用户是否可以以及对应的用户身份。k8s利用数字证书可以保证直接签发的证书是可信的来实现用户管理，其中签发的证书包含了用户的租和用户id。

##### 用户创建

###### cfssl方式

1. 配置ca证书签发子证书的方式，配置文件为json格式，其中`kubernetes-user`代表对应创建k8s用户时使用的ssl证书配置，主要描述子证书的作用和失效时间。
   
   ```json
   {
     "signing": {
       "default": {
         "expiry": "87600h"
       },
       "profiles": {
         "kubernetes-user": {
           "usages": [
               "signing", "key encipherment","client auth"
           ],
           "expiry": "87600h"
         }
       }
     }
   }
   ```

2. 创建用户证书的json配置文件。其中`CN`控制用户名，`O`控制用户组
   
   ```json
   {
     "CN": "user-a",    
     "key": {
       "algo": "rsa",
       "size": 2048
     },
     "names": [
       {
         "C": "CN",
         "ST": "GuangDong",
         "L": "ShenZhen",
         "O": "user-group-a",
         "OU": "System"
       }
     ]
     "hosts": [
           "*.example.com",
           "www.example.com",
           "https://www.example.com",
           "jdoe@example.com",
           "127.0.0.1"
       ],
   }   
   ```

3. 运行cfssl命令生成用户的公钥和私钥。其中`ca-config.json`是第一步的配置文件，`user-a.json`是第二步的配置文件。
   
   ```bash
   cfssl gencert -ca=ca.pem -ca-key=ca-key.pem \
   -config=ca-config.json -profile=kubernetes-user \
   user-a.json | cfssljson -bare user-a
   ```

##### 多用户上下文切换

###### kubectl

- kubectl使用配置文件管理当前的用户上下文，主要包含用户证书和对应集群的信息以及默认访问的namespace。

- kubectl通过环境变量`KUBECONFIG`确定配置文件路径

配置文件主要包含三部分内容`clusters`，`users`，`contexts`，文件结构如下

```yaml
apiVersion: v1
kind: Config
current-context: xxx-user@xxx-cluster
clusters:
users:
contexts: 
preferences: 
```

- `clusters`:主要存放每个集群的apiserver的地址以及ca证书。

- `users`:用于配置用户公钥和私钥

- `contexts`:用户配置每个可用的上下文，即那个用户使用哪个集群

配置命令：

1. 设置集群信息
   
   ```bash
   kubectl config set-cluster < cluster profile name > \
   --embed-certs=true \
   --certificate-authority=< cluster public key file > \
   --server="< cluster api server address >" \
   --kubeconfig=< config file location >
   ```

2. 设置用户信息
   
   ```bash
   kubectl config set-credentials < user profile name > \
   --embed-certs=true \
   --client-certificate=< user public key > \
   --client-key=< user private key >   \
   --kubeconfig=< config file location >
   ```

3. 设置上下文
   
   ```bash
   kubectl config set-context < context profile name > \
   --cluster=< cluster profile name > \
   --user=< user profile name > \
   --namespace=< default namespace > \
   --kubeconfig=< config file location >
   ```

4. 切换上下文
   
   ```bash
   kubectl config use-context < context profile name >
   ```

**注意点**

- `kubectl config`命令只是用于设置配置文件，不包含赋权操作，如果
