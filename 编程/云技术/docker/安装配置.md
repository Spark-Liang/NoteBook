### 安装配置

- 安装

- 配置
  
  - 配置文件
  
  - 使用daemon配置文件

- 安装配置本地仓库

#### 安装

#### 安装前准备

- 关闭firewalld和selinux

- 配置IP转发

- 

##### 安装docker-ce

docker-ce是现在的社区稳定版，docker是开发版，通常安装docker-ce

```bash
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum -y install docker-ce
```

###### 使用阿里云的 yum 源安装 docker

在 ref 文件夹中复制repo文件到 /etc/yum/repos.d 目录下，然后运行以下命令。

```bash
sudo yum update -y
sudo yum install -y docker-ce
```

#### 配置

##### 配置文件

配置文件路径：/etc/systemd/system/multi-user.target.wants/docker.service<br>

最终启动docker后台进程是用过 `dockerd`命令。所有的dockerd选项可以参考[dockerd 官方文档](https://docs.docker.com/engine/reference/commandline/dockerd/)。

##### 添加阿里云镜像源

###### Ubuntu 16.04、Debian 8 Jessie、CentOS 7

用 systemctl enable docker 启用服务后，编辑
/etc/systemd/system/multi-user.target.wants/docker.service 文件，找
到 ExecStart= 这一行，在这行最后添加加速器地址 --registry-mirror=<加
速器地址> ，如：

```bash
ExecStart=/usr/bin/dockerd 
--registry-mirror=https://jxus37ad.mirror.aliyuncs.com
```

参考[官方镜像加速 - 容器镜像服务 ACR - 阿里云](https://help.aliyun.com/document_detail/60750.html)阿里云的镜像加速地址

然后然后重启服务

```bash
sudo systemctl daemon-reload

sudo systemctl restart docker
```

###### 修改镜像存储位置

在配置文件中添加如下选项

```bash
--graph=/data/docker
```

或者在`/etc/docker/daemon.json`通过`graph`配置路径

##### 使用 daemon配置文件

默认情况下`dockerd`命令会使用 `/etc/docker/daemon.json`作为配置文件。

###### 通过daemon配置镜像源

通过registry-mirrors字段配置镜像列表

```json
{
    "registry-mirrors": ["http://hub-mirror.c.163.com"]
}
```

可用的镜像列表是：

- http://hub-mirror.c.163.com

- [Docker镜像获取（gcr.io等）](https://zhuanlan.zhihu.com/p/57147300)

#### 安装配置本地仓库

##### 

##### 配置仓库使用tls

1. 生成ca证书和服务器证书

2. 将ca文件拷贝到`/etc/pki/ca-trust/source/anchors/`

3. 调用`update-ca-trust`，更新受信任列表

4. 重启docker

5. 

[搭建具有认证、TLS的docker registry私有仓库 &#8211; 阿汤博客](https://www.amd5.cn/atang_3828.html)

[[Docker]docker搭建私有仓库(ssl、身份认证) - 行走的DT - 博客园](https://www.cnblogs.com/ttkl/p/11040932.html)
